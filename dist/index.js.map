{"version":3,"file":"index.js","sources":["../src/parse.js","../src/fetch.js"],"sourcesContent":["/**\n * SSE 文本解析\n * @param {string} chunk - decode 后的 SSE 格式数据块\n * @param {Function} callback\n * @param {Object} instance\n */\nfunction eventsourceParser(chunk, callback, options = {}) {\n  let message = {};\n  const {\n    instance = eventsourceParser,\n    parseJson = true\n  } = options;\n  const buffer = (instance.buffer || '') + chunk;\n  const lines = buffer.split('\\n');\n  const onMessage = (message) => callback?.(message);\n\n  // SSE 规范要求每个事件使用空行即 \\n\\n 进行分割\n  // 移除最后一行，若事件完整则为空行，若事件不完整则留作下次处理\n  instance.buffer = lines.pop();\n\n  // 若数据为空则直接返回\n  if (lines.length === 0) {\n    return onMessage(message, 0);\n  }\n\n  // 解析原始数据\n  lines.forEach((item) => {\n    // 空行表示一个完整事件的结束\n    if (item.trim() === '') {\n      // 是否自动解析 JSON\n      if (parseJson) {\n        try {\n          message.data = JSON.parse(message.data);\n        } catch(e) {}\n      }\n      onMessage(message); // 返回数据\n      message = {}; // 重置事件返回的数据\n    } else {\n      const fieleLength = item.indexOf(':');\n      const field = item.substring(0, fieleLength).trim();\n      const value = item.substring(fieleLength + 1).trim();\n\n      // 处理数据\n      if (field) {\n        switch (field) {\n          case 'data':\n            message.data = value;\n            break;\n          default: // id, event, retry\n            message[field] = /^\\d+$/.test(value) ? parseInt(value) : value;\n        }\n      }\n    }\n  });\n};\n\nexport default eventsourceParser;\n","import eventsourceParser from './parse.js';\n\nclass FetchEventSource {\n  constructor() {\n    this.controller = new AbortController();\n  }\n\n  /**\n   * 发起请求\n   * @param {string} url\n   * @param {Object} options\n   */\n  async fetch( url, options = {} ) {\n    const {\n      headers,\n      signal = this.controller.signal,\n      parseJson = true\n    } = options;\n\n    // 默认 headers\n    options.headers = {\n      \"Content-Type\": \"application/json\",\n      \"Accept\": \"text/event-stream\",\n      ...headers,\n    };\n\n    try {\n      const response = await fetch(url, {\n        signal,\n        ...options,\n      });\n\n      // 响应异常\n      if (!response.ok) {\n        const contentType = response.headers.get('content-type');\n        const ACCEPT = options.headers['Accept'];\n        if (!String(contentType).startsWith(ACCEPT)) {\n          console.error(`Expected content-type to be ${ACCEPT}, Actual: ${contentType}`);\n        }\n        throw new Error(`HTTP ${response.status}`);\n      }\n\n      options.onOpen?.(response);\n\n      // 读取流\n      const reader = response.body.getReader();\n      const decoder = new TextDecoder();\n      async function readStream() {\n        const { done, value } = await reader.read();\n\n        // DONE\n        if (done) return options.done?.(response);\n\n        const chunk = decoder.decode(value); // 解码 Uint8Array\n        eventsourceParser(chunk, options.onMessage, { instance: this, parseJson }); // 解析 SSE 数据格式\n\n        await readStream();\n      }\n      await readStream();\n    } catch(error) {\n      this.abort();\n      delete this.buffer;\n      options.onError?.(error);\n    }\n  }\n\n  // 中断请求\n  abort() {\n    this.controller.abort();\n  }\n}\n\n// 创建实例\nexport async function fetchEventSource(...args) {\n  const eventSource = new FetchEventSource();\n  await eventSource.fetch(...args);\n  return eventSource;\n};\n\nexport { eventsourceParser };\n"],"names":["eventsourceParser","chunk","callback","options","message","instance","parseJson","buffer","lines","split","onMessage","pop","length","forEach","item","trim","data","JSON","parse","e","fieleLength","indexOf","field","substring","value","test","parseInt","FetchEventSource","constructor","controller","AbortController","fetch","url","headers","signal","response","ok","contentType","get","ACCEPT","String","startsWith","console","error","Error","status","onOpen","reader","body","getReader","decoder","TextDecoder","readStream","done","read","decode","abort","onError","fetchEventSource","args","eventSource"],"mappings":"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"}